<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Indoor Plant Details</title>
  <link rel="stylesheet" href="styles.css" />
  <style>
    html {
      padding: 0 !important;
    }
  </style>
  <style>
    body {
      margin: 0;
      font-family: 'Segoe UI', sans-serif;
      background-size: cover;
      background-repeat: no-repeat;
      background-position: center;
      background-attachment: fixed;
      position: relative;
    }

    body::before {
      content: "";
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255, 255, 255, 0.6);
      backdrop-filter: blur(12px);
      z-index: -1;
      background-repeat: no-repeat;
      background-size: cover;
      background-position: center;
    }
  </style>
</head>
<body>
  <button class="back-button" onclick="history.back()">â† Back</button>

  <div id="plantDetails" class="plant-details-container"></div>

  <div id="imageModal" class="image-modal" aria-hidden="true" role="dialog" aria-label="Enlarged image">
    <div class="modal-content" role="document">
      <button class="close-modal" id="closeModal" aria-label="Close enlarged image">âœ•</button>
      <img id="modalImage" alt="" />
    </div>
  </div>

  <script>
    (function () {
      const params = new URLSearchParams(window.location.search);
      const plantId = params.get("id");
      const plantDetails = document.getElementById("plantDetails");
      const imageModal = document.getElementById("imageModal");
      const modalImage = document.getElementById("modalImage");
      const closeModal = document.getElementById("closeModal");

      function openModal(src, alt) {
        modalImage.src = src || '';
        modalImage.alt = alt || '';
        imageModal.classList.add('open');
        imageModal.setAttribute('aria-hidden', 'false');
        closeModal.focus();
        document.body.style.overflow = 'hidden';
      }

      function closeImageModal() {
        imageModal.classList.remove('open');
        imageModal.setAttribute('aria-hidden', 'true');
        modalImage.src = '';
        document.body.style.overflow = '';
      }

      imageModal.addEventListener('click', (e) => {
        if (e.target === imageModal) closeImageModal();
      });
      closeModal.addEventListener('click', closeImageModal);
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && imageModal.classList.contains('open')) closeImageModal();
      });

      fetch("http://localhost:3000/api/indoor-plants")
        .then(res => res.json())
        .then(plants => {
          const plant = plants.find(p => p["Plant ID"] === plantId);
          if (!plant) {
            plantDetails.innerHTML = "<p>Plant not found.</p>";
            return;
          }

          const bgImage = plant.Image || '';
          document.body.style.backgroundImage = `url('${bgImage}')`;

          let detailsHtml = `
            <div class="plant-details-card">
              <div class="plant-header">
                <img src="${bgImage}" alt="${plant['Common name'] || ''}" class="plant-thumbnail" id="mainThumb" tabindex="0" />
                 <h1>${plant["Scientific name"] || ''} <span>(${plant["Common name"] || ''})</span></h1>
              </div>
              <ul class="plant-info">
                <li><span>ğŸ”¬</span><strong>Scientific name:</strong> ${plant["Scientific name"] || 'â€”'}</li>
                <li><span>ğŸŒ¿</span><strong>Common name:</strong> ${plant["Common name"] || 'â€”'}</li>
                <li><span>â˜€ï¸</span><strong>Light Requirements:</strong> ${plant["Light Requirements"] || 'â€”'}</li>
                <li><span>ğŸŒ¡ï¸</span><strong>Stable Temperature:</strong> ${plant["Stable temperature"] || "â€”"}</li>
                <li><span>ğŸ’§</span><strong>Watering:</strong> ${plant["Watering"] || "â€”"}</li>
                <li><span>ğŸ”¢</span><strong>Total Quantity:</strong> ${plant["Quantity"] ?? 'â€”'}</li>
              </ul>

              <h2>ğŸ“ Locations</h2>
              <div class="locations-list">
          `;

          (plant.Locations || []).forEach(loc => {
            detailsHtml += `
              <div class="location-card">
                <p><strong>${loc["Location number"]}</strong></p>
                <p>${loc["Location name"]}</p>
                <p>Quantity: ${loc["Quantity"]}</p>
              </div>
            `;
          });

          detailsHtml += `</div>`; // close locations-list

          if (plant["PDF link"]) {
            const pdfUrl = plant["PDF link"];
            detailsHtml += `
              <div class="pdf-section" aria-label="Plant documentation">
                <div class="pdf-controls">
                  <button class="pdf-button" id="viewPdfBtn">View PDF</button>
                </div>
                <div class="pdf-viewer" id="pdfViewer" hidden>
                  <iframe src="${pdfUrl}"></iframe>
                </div>
              </div>
            `;
          }

          detailsHtml += `</div>`; // close plant-details-card
          plantDetails.innerHTML = detailsHtml;

          const thumb = document.getElementById('mainThumb');
          if (thumb) {
            thumb.addEventListener('click', () => openModal(bgImage, plant['Common name'] || ''));
            thumb.addEventListener('keydown', (e) => {
              if (e.key === 'Enter' || e.key === ' ') {
                e.preventDefault();
                openModal(bgImage, plant['Common name'] || '');
              }
            });
          }

          const viewPdfBtn = document.getElementById('viewPdfBtn');
          const pdfViewer = document.getElementById('pdfViewer');
          if (viewPdfBtn && pdfViewer) {
            viewPdfBtn.addEventListener('click', () => {
              const isHidden = pdfViewer.hasAttribute('hidden');
              if (isHidden) {
                pdfViewer.removeAttribute('hidden');
                viewPdfBtn.textContent = 'Hide PDF';
                pdfViewer.querySelector('iframe').focus();
              } else {
                pdfViewer.setAttribute('hidden', '');
                viewPdfBtn.textContent = 'View PDF';
              }
            });
          }
        })
        .catch(err => {
          console.error("Fetch error:", err);
          plantDetails.innerHTML = "<p>Unable to load plant data.</p>";
        });
    })();
  </script>
</body>
</html>
