<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Outdoor Plant Details</title>
  <link rel="stylesheet" href="styles.css" />
  <style>
    html {
      padding: 0 !important;
    }
  </style>
  <style>
    body {
      margin: 0;
      font-family: 'Segoe UI', sans-serif;
      background-size: cover;
      background-repeat: no-repeat;
      background-position: center;
      background-attachment: fixed;
      position: relative;
    }

    body::before {
      content: "";
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255, 255, 255, 0.6);
      backdrop-filter: blur(12px);
      z-index: -1;
      background-repeat: no-repeat;
      background-size: cover;
      background-position: center;
    }
  </style>
</head>
<body>
  <button class="back-button" onclick="history.back()">‚Üê Back</button>

  <div id="plantDetails" class="plant-details-container"></div>

  <!-- Image modal -->
  <div id="imageModal" class="image-modal" aria-hidden="true" role="dialog" aria-label="Enlarged image">
    <div class="modal-content" role="document">
      <button class="close-modal" id="closeModal" aria-label="Close enlarged image">‚úï</button>
      <img id="modalImage" alt="" />
    </div>
  </div>

  <script>
    (function () {
      const params = new URLSearchParams(window.location.search);
      const plantId = params.get("id");
      const plantDetails = document.getElementById("plantDetails");
      const imageModal = document.getElementById("imageModal");
      const modalImage = document.getElementById("modalImage");
      const closeModal = document.getElementById("closeModal");

      function openModal(src, alt) {
        modalImage.src = src || '';
        modalImage.alt = alt || '';
        imageModal.classList.add('open');
        imageModal.setAttribute('aria-hidden', 'false');
        closeModal.focus();
        document.body.style.overflow = 'hidden';
      }

      function closeImageModal() {
        imageModal.classList.remove('open');
        imageModal.setAttribute('aria-hidden', 'true');
        modalImage.src = '';
        document.body.style.overflow = '';
      }

      imageModal.addEventListener('click', (e) => {
        if (e.target === imageModal) closeImageModal();
      });
      closeModal.addEventListener('click', closeImageModal);
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && imageModal.classList.contains('open')) closeImageModal();
      });

      fetch("http://localhost:3000/api/outdoor-plants")
        .then(res => res.json())
        .then(plants => {
          const plant = plants.find(p => p["Plant ID"] === plantId);
          if (!plant) {
            plantDetails.innerHTML = "<p>Plant not found.</p>";
            return;
          }

          const bgImage = plant.Image || '';
          document.body.style.backgroundImage = `url('${bgImage}')`;

          let detailsHtml = `
            <div class="plant-details-card">
              <div class="plant-header">
                <img src="${bgImage}" alt="${plant['Common name'] || ''}" class="plant-thumbnail" id="mainThumb" tabindex="0" />
                <h1>${plant["Scientific name"] || ''} <span>(${plant["Common name"] || ''})</span></h1>
              </div>
              <ul class="plant-info">
          `;

          const excludedKeys = ["Plant ID", "Picture", "Image", "Locations", "PDF link"];
          const iconMap = {
            "Scientific name": "üî¨",
            "Common name": "üåø",
            "Category": "üìÇ",
            "life cycle": "üîÅ",
            "Water requirement": "üíß",
            "Sun requirement": "‚òÄÔ∏è",
            "Height (m)": "üìè",
            "Spread (m)": "üìê",
            "Shade": "üå§Ô∏è",
            "Root type": "üå±",
            "Drought tolerance": "üî•",
            "Heat tolerance": "üî•",
            "Continuous bloom": "üåº",
            "Environmental impact": "‚ôªÔ∏è",
            "Oxygen gas production (g/year)": "O‚ÇÇ",
            "Carbon dioxide gas absorption (g/year)": "CO‚ÇÇ",
            "waste": "üóëÔ∏è",
            "Evaporation mitigation": "üí®"
          };

          Object.keys(plant).forEach(key => {
            if (!excludedKeys.includes(key)) {
              const value = plant[key];
              const icon = iconMap[key] || "üìÑ";
              detailsHtml += `<li><span>${icon}</span><strong>${key}:</strong> ${value}</li>`;
            }
          });

          detailsHtml += `</ul></div>`; // close plant-info and card
          plantDetails.innerHTML = detailsHtml;

          const thumb = document.getElementById('mainThumb');
          if (thumb) {
            thumb.addEventListener('click', () => openModal(bgImage, plant['Common name'] || ''));
            thumb.addEventListener('keydown', (e) => {
              if (e.key === 'Enter' || e.key === ' ') {
                e.preventDefault();
                openModal(bgImage, plant['Common name'] || '');
              }
            });
          }
        })
        .catch(err => {
          console.error("Fetch error:", err);
          plantDetails.innerHTML = "<p>Unable to load plant data.</p>";
        });
    })();
  </script>
</body>
</html>
